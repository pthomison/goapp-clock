version: "3"

tasks:
  clean:
    cmds:
      - rm -rf ./docs
      - rm -rf ./web
      - rm -rf ./tmp

  tidy-n-fmt:
    cmds:
      - go mod tidy
      - go fmt ./...

  npm-deps:
    cmds:
      - npm install

  bundle:
    cmds:
      - ./node_modules/.bin/esbuild index.js --bundle --outfile=./web/index.js
      - cp -R ./static ./web/

  build-webapp:
    cmds:
      - task: tidy-n-fmt
      - task: bundle
      - GOARCH=wasm GOOS=js go build -o ./web/app.wasm ./cmd/webapp/...

  build-server:
    cmds:
      - task: build-webapp
      - go build -o tmp/goappclock-server ./cmd/server/...

  run:
    cmds:
      - task: build-webapp
      - go run ./cmd/server/...

  dev:
    cmds:
      - task: tidy-n-fmt
      - task: npm-deps
      - air

  gh-pages:
    cmds:
      - task: build-webapp
      - go run ./cmd/build/... --path goapp-clock --out docs
      - mv ./web/* ./docs/web/ && rm -r ./web

  static-host:
    cmds:
      - task: gh-pages
      - python3 -m http.server --directory . 8888
